name: Claude â€” Draft Requirements

# Auto-fires once when a new issue is opened (no @claude mention needed).
# Claude reads the issue and posts a structured requirements breakdown.
# use_sticky_comment ensures re-runs update the existing comment rather than adding new ones.
#
# Does NOT fire on issue comments â€” follow-up discussion is handled by claude.yml
# when the user tags @claude, or the user can trigger a re-analysis by commenting @claude.

on:
  issues:
    types: [opened]

jobs:
  requirements:
    # Skip issues that already contain @claude â€” those go to claude.yml instead.
    if: |
      !contains(github.event.issue.body, '@claude') &&
      !contains(github.event.issue.title, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Write MCP config
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "vercel": {
                "command": "npx",
                "args": ["-y", "mcp-remote", "https://mcp.vercel.com", "--header", "Authorization:Bearer $VERCEL_TOKEN"]
              },
              "railway": {
                "command": "npx",
                "args": ["-y", "@railway/mcp-server"],
                "env": {
                  "RAILWAY_TOKEN": "$RAILWAY_TOKEN"
                }
              }
            }
          }
          EOF
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          claude_args: --mcp-config /tmp/mcp-config.json
          prompt: |
            Read CLAUDE.md to understand the project. Then analyze this issue carefully.

            Post a requirements breakdown using this exact markdown structure:

            ---
            ## ðŸ“‹ Requirements Analysis

            **Goal:** [one sentence restatement of what the user wants]

            **Acceptance Criteria**
            - [ ] [concrete, testable criterion]
            - [ ] [concrete, testable criterion]

            **Files Likely Affected**
            | File | Change needed |
            |---|---|
            | `path/to/file` | [description] |

            **Open Questions**
            - [Any ambiguity that needs clarification, or "None"]

            ---
            > Ready to implement? Comment `@claude implement` on this issue.

            Rules:
            - Do NOT write any code. This is analysis only.
            - If it's a bug report, add a "Root Cause Hypothesis" section. For bug reports,
              FIRST use the Railway and Vercel MCP tools to check recent logs for relevant
              errors or stack traces, then base your hypothesis on actual log evidence.
              Quote specific log lines if found.
            - If it involves a new Garmin data source, note which garth endpoint to call
              and what type to add to src/types/index.ts.
            - Keep the whole comment under 400 words.
