name: Claude â€” Draft Requirements

# Fires automatically whenever a new issue is opened OR when a comment is added to an issue.
# Claude reads the entire thread and posts an updated requirements breakdown.
# No @claude mention needed â€” this is fully automatic.

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  requirements:
    # Run on new issues, OR on issue comments (not PR comments, not bot comments)
    if: |
      (github.event_name == 'issues' &&
       !contains(github.event.issue.body, '@claude') &&
       !contains(github.event.issue.title, '@claude')) ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request == null &&
       github.event.comment.user.type != 'Bot' &&
       !contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            Read CLAUDE.md to understand the project. Then read ALL comments on this issue
            to get the full context of the discussion so far.

            Post (or update your previous) comment on this issue with the following structure
            (use this exact markdown format):

            ---
            ## ðŸ“‹ Requirements Analysis

            **Goal:** [one sentence restatement of what the user wants]

            **Acceptance Criteria**
            - [ ] [concrete, testable criterion]
            - [ ] [concrete, testable criterion]

            **Files Likely Affected**
            | File | Change needed |
            |---|---|
            | `src/...` | [description] |

            **Open Questions**
            - [Any ambiguity you need the user to clarify before implementing, or "None" if all questions have been answered in the thread]

            ---
            > When you're ready for implementation, comment `@claude implement` on this issue.

            Rules:
            - Do NOT write any code. This is planning only.
            - If the issue is a bug report, add a "Root Cause Hypothesis" section.
            - If the issue asks for a new Garmin data source, note which garmin-connect
              method to use and what type to add to src/types/index.ts.
            - If this is triggered by a new comment, incorporate any answers/clarifications
              from the thread into the updated requirements.
            - Keep the whole comment under 400 words.
