name: Claude — Review PR

# Auto-fires on every non-draft PR open or new push.
# Claude posts a thorough code review as a PR review (APPROVE / REQUEST_CHANGES / COMMENT).

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read # needed to read CI results

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Write MCP config
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "vercel": {
                "command": "npx",
                "args": ["--package", "@vercel/sdk", "mcp", "start", "--bearer-token", "$VERCEL_TOKEN"]
              },
              "railway": {
                "command": "npx",
                "args": ["-y", "@railway/mcp-server"],
                "env": {
                  "RAILWAY_API_TOKEN": "$RAILWAY_TOKEN"
                }
              }
            }
          }
          EOF
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: --mcp-config /tmp/mcp-config.json
          prompt: |
            Read CLAUDE.md and AGENTS.md, then perform a thorough code review of this PR.

            Review checklist — flag any violation with a specific file + line reference:

            **Correctness**
            - [ ] TypeScript strict mode: no `any`, no `@ts-ignore` without explanation
            - [ ] New shared types go in src/types/index.ts, not inline
            - [ ] Garmin API calls in garmin_client.py are wrapped in try/except (never fail silently)
            - [ ] garmin_client functions accept garth.Client param — no global garth singleton calls
            - [ ] No `console.log` in production code paths

            **Security**
            - [ ] No credentials, API keys, or tokens appear in any committed file
            - [ ] Backend routes never return raw Garmin session tokens or credentials to the client
            - [ ] No new `.env`-style files committed
            - [ ] session_token handled correctly (encrypted Fernet token, stored in sessionStorage only)

            **Architecture**
            - [ ] Garmin data fetching goes through backend/garmin_client.py (not npm packages)
            - [ ] FastAPI routes in backend/main.py follow the existing pattern
            - [ ] API routes stay in src/app/api/ with Node.js runtime (not Edge)
            - [ ] `'use client'` only on components that genuinely need browser APIs

            **Style**
            - [ ] Tailwind utility classes only (no inline style=, no CSS modules)
            - [ ] Brand colors use `garmin-blue` / `garmin-dark` Tailwind tokens

            **Testing**
            - [ ] New logic has corresponding tests
            - [ ] New React components have @testing-library tests
            - [ ] Coverage thresholds (60% lines/functions/branches) not regressed

            **PR hygiene**
            - [ ] PR description explains *why*, not just *what*
            - [ ] "Closes #issue" link present if this fixes an issue
            - [ ] PR template checklist items filled in

            **Deployment health** (check if CI failed or deployment issues exist)
            - If CI is failing, use Railway and Vercel MCP tools to check recent logs for
              relevant errors before commenting on the cause.

            Post your review as a PR review (APPROVE, REQUEST_CHANGES, or COMMENT).
            - Approve only if all checklist items pass.
            - Request changes if any hard rule from CLAUDE.md is violated.
            - Comment if you have suggestions but nothing blocking.
            Be specific and direct. Reference exact file paths and line numbers.
